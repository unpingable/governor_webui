<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Governor Dashboard</title>
<style>
  :root {
    --bg: #fff; --fg: #111; --muted: #666; --border: #ddd;
    --card-bg: #fafafa; --badge-ok: #22c55e; --badge-warn: #eab308; --badge-block: #ef4444;
    --accent: #3b82f6; --accent-light: #eff6ff;
    --code-bg: #f3f4f6; --code-border: #e5e7eb;
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #111; --fg: #eee; --muted: #999; --border: #333;
      --card-bg: #1a1a1a; --accent-light: #1e3a5f;
      --code-bg: #1e1e1e; --code-border: #333;
    }
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--fg); line-height: 1.5; height: 100vh; overflow: hidden; }

  /* Layout: controls left, output right */
  .app { display: grid; grid-template-columns: 320px 1fr; grid-template-rows: 1fr auto; height: 100vh; }

  /* Controls Panel */
  .controls { grid-row: 1 / 2; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; }
  .controls-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem; }
  .controls-header h1 { font-size: 1rem; font-weight: 600; }
  .controls-header .version { font-size: 0.7rem; color: var(--muted); }
  .controls-body { padding: 1rem; flex: 1; overflow-y: auto; }

  .field { margin-bottom: 1rem; }
  .field label { display: block; font-size: 0.8rem; font-weight: 500; margin-bottom: 0.25rem; }
  .field .hint { font-size: 0.7rem; color: var(--muted); margin-bottom: 0.25rem; }
  .field select, .field input, .field textarea {
    width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px;
    background: var(--bg); color: var(--fg); font-size: 0.85rem; font-family: inherit;
  }
  .field textarea { resize: vertical; min-height: 80px; }
  .field select:focus, .field input:focus, .field textarea:focus { outline: none; border-color: var(--accent); }

  .advanced-toggle { font-size: 0.75rem; color: var(--accent); cursor: pointer; margin-bottom: 0.75rem; }
  .advanced-fields { display: none; }
  .advanced-fields.visible { display: block; }

  .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .btn { padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.85rem; background: var(--card-bg); color: var(--fg); }
  .btn:hover { border-color: var(--muted); }
  .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn.primary:hover { opacity: 0.9; }
  .btn.danger { background: var(--badge-block); border-color: var(--badge-block); color: #fff; }
  .btn.danger:hover { opacity: 0.9; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .active-run-indicator { padding: 0.5rem 0.75rem; background: var(--accent-light); border-radius: 6px; font-size: 0.8rem; margin-bottom: 1rem; display: none; }
  .active-run-indicator.visible { display: flex; align-items: center; gap: 0.5rem; }
  .spinner { width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Templates */
  .templates { margin-bottom: 1rem; }
  .template-card { padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 0.5rem; cursor: pointer; background: var(--card-bg); }
  .template-card:hover { border-color: var(--accent); }
  .template-card .name { font-size: 0.85rem; font-weight: 500; }
  .template-card .desc { font-size: 0.75rem; color: var(--muted); }

  /* Output Panel */
  .output { grid-row: 1 / 2; display: flex; flex-direction: column; min-height: 0; }
  .tabs { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .tab { padding: 0.6rem 1.2rem; font-size: 0.85rem; cursor: pointer; border-bottom: 2px solid transparent; color: var(--muted); }
  .tab:hover { color: var(--fg); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 500; }
  .tab-content { flex: 1; overflow-y: auto; padding: 1rem; display: none; }
  .tab-content.active { display: block; }

  /* Run list */
  .run-list { list-style: none; }
  .run-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 0; border-bottom: 1px solid var(--border); cursor: pointer; }
  .run-item:hover { background: var(--accent-light); margin: 0 -1rem; padding: 0.6rem 1rem; border-radius: 6px; }
  .run-item:last-child { border-bottom: none; }
  .verdict-badge { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
  .verdict-badge.pass { background: #dcfce7; color: #166534; }
  .verdict-badge.fail { background: #fee2e2; color: #991b1b; }
  .verdict-badge.cancelled { background: #fef3c7; color: #92400e; }
  .verdict-badge.pending { background: var(--accent-light); color: var(--accent); }
  .verdict-badge.error { background: #fee2e2; color: #991b1b; }
  .run-info { flex: 1; }
  .run-info .task { font-size: 0.85rem; font-weight: 500; }
  .run-info .meta { font-size: 0.75rem; color: var(--muted); }
  .empty-state { text-align: center; color: var(--muted); padding: 3rem 1rem; font-size: 0.9rem; }

  /* Detail view */
  .detail-header { margin-bottom: 1rem; }
  .detail-header h2 { font-size: 1rem; font-weight: 600; }
  .detail-header .meta { font-size: 0.8rem; color: var(--muted); }
  .detail-section { margin-bottom: 1.5rem; }
  .detail-section h3 { font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.25rem; }
  table.detail-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  table.detail-table th { text-align: left; padding: 0.4rem 0.5rem; background: var(--card-bg); border-bottom: 1px solid var(--border); font-weight: 500; }
  table.detail-table td { padding: 0.4rem 0.5rem; border-bottom: 1px solid var(--border); }
  .repro-block { background: var(--code-bg); border: 1px solid var(--code-border); border-radius: 6px; padding: 0.75rem; font-family: 'SF Mono', Menlo, monospace; font-size: 0.8rem; overflow-x: auto; }

  /* Status Bar */
  .status-bar { grid-column: 1 / -1; border-top: 1px solid var(--border); padding: 0.4rem 1rem; font-size: 0.75rem; color: var(--muted); display: flex; gap: 1.5rem; align-items: center; background: var(--card-bg); }
  .status-bar .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .status-bar .dot.ok { background: var(--badge-ok); }
  .status-bar .dot.warn { background: var(--badge-warn); }
</style>
</head>
<body>

<div class="app">
  <!-- Controls Panel -->
  <div class="controls">
    <div class="controls-header">
      <h1>Governor Dashboard</h1>
      <span class="version">v2</span>
      <a href="/" style="font-size:0.75rem;color:var(--muted);text-decoration:none;margin-left:auto;" data-testid="nav-chat">Chat</a>
    </div>
    <div class="controls-body">
      <!-- Templates -->
      <div class="templates" id="templates-section"></div>

      <!-- Dynamic fields from schema -->
      <div id="controls-fields"></div>

      <!-- Advanced toggle -->
      <div class="advanced-toggle" id="advanced-toggle" onclick="toggleAdvanced()">Show advanced...</div>
      <div class="advanced-fields" id="advanced-fields"></div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn primary" id="btn-start" onclick="startRun()" data-testid="start-run">Start Run</button>
        <button class="btn danger" id="btn-cancel" onclick="cancelRun()" disabled data-testid="cancel-run">Stop</button>
        <button class="btn" id="btn-rerun" onclick="rerunLast()" disabled data-testid="rerun-last">Rerun Last</button>
      </div>

      <!-- Active run indicator -->
      <div class="active-run-indicator" id="active-indicator">
        <div class="spinner"></div>
        <span id="active-run-label">Running...</span>
      </div>
    </div>
  </div>

  <!-- Output Panel -->
  <div class="output">
    <div class="tabs">
      <div class="tab active" data-tab="runs" onclick="switchTab('runs')">Runs</div>
      <div class="tab" data-tab="detail" onclick="switchTab('detail')">Detail</div>
      <div class="tab" data-tab="artifacts" onclick="switchTab('artifacts')">Artifacts</div>
    </div>

    <!-- Runs Tab -->
    <div class="tab-content active" id="tab-runs">
      <div id="runs-filter" style="margin-bottom: 1rem; display: flex; gap: 0.5rem; align-items: center;">
        <select id="filter-verdict" onchange="loadRuns()" style="padding: 0.3rem 0.5rem; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--fg); font-size: 0.8rem;">
          <option value="">All verdicts</option>
          <option value="pass">Pass</option>
          <option value="fail">Fail</option>
          <option value="cancelled">Cancelled</option>
          <option value="pending">Pending</option>
        </select>
      </div>
      <ul class="run-list" id="run-list" data-testid="run-list"></ul>
      <div class="empty-state" id="runs-empty">No runs yet. Start one from the controls panel.</div>
    </div>

    <!-- Detail Tab -->
    <div class="tab-content" id="tab-detail">
      <div class="empty-state" id="detail-empty">Select a run to view details.</div>
      <div id="detail-content" style="display: none;" data-testid="detail-content"></div>
    </div>

    <!-- Artifacts Tab -->
    <div class="tab-content" id="tab-artifacts">
      <div class="empty-state" id="artifacts-empty">Select a run to view artifacts.</div>
      <div id="artifacts-content" style="display: none;"></div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar" id="status-bar" data-testid="status-bar">
    <span><span class="dot ok"></span> Connected</span>
    <span id="status-regime">Regime: --</span>
    <span id="status-profile">Profile: --</span>
    <span id="status-verdict">Last: --</span>
    <span id="status-runs">Runs: 0</span>
  </div>
</div>

<script>
// State
let currentRunId = null;
let activeRunId = null;
let controlsSchema = null;
let lastRuns = [];

// ---- Init ----
async function init() {
  await loadControlsSchema();
  await loadTemplates();
  await loadRuns();
  startStatusPolling();
}

// ---- Controls Schema ----
async function loadControlsSchema() {
  try {
    const res = await fetch('/v2/controls/schema');
    controlsSchema = await res.json();
    renderControls(controlsSchema);
  } catch (e) {
    console.error('Failed to load controls schema:', e);
  }
}

function renderControls(schema) {
  const container = document.getElementById('controls-fields');
  const advancedContainer = document.getElementById('advanced-fields');
  container.innerHTML = '';
  advancedContainer.innerHTML = '';

  const props = schema.properties || {};
  for (const [name, spec] of Object.entries(props)) {
    const html = renderField(name, spec);
    if (spec['x-advanced']) {
      advancedContainer.insertAdjacentHTML('beforeend', html);
    } else {
      container.insertAdjacentHTML('beforeend', html);
    }
  }

  // Load dynamic dropdowns (backends)
  loadDynamicDropdowns(props);
}

function renderField(name, spec) {
  const label = spec['x-label'] || name;
  const desc = spec['x-description'] || '';
  const render = spec['x-render'] || 'text';

  let input = '';
  if (render === 'dropdown') {
    if (spec.enum) {
      const options = spec.enum.map(v =>
        `<option value="${v}" ${v === spec.default ? 'selected' : ''}>${v}</option>`
      ).join('');
      input = `<select id="ctrl-${name}">${options}</select>`;
    } else {
      input = `<select id="ctrl-${name}"><option value="">Loading...</option></select>`;
    }
  } else if (render === 'textarea') {
    input = `<textarea id="ctrl-${name}" placeholder="${desc}"></textarea>`;
  } else if (render === 'tag-input') {
    input = `<input id="ctrl-${name}" type="text" placeholder="comma-separated paths">`;
  } else if (render === 'number') {
    input = `<input id="ctrl-${name}" type="number" value="${spec.default || ''}">`;
  } else {
    input = `<input id="ctrl-${name}" type="text" value="${spec.default || ''}">`;
  }

  return `<div class="field" data-testid="field-${name}"><label>${label}</label>${desc ? `<div class="hint">${desc}</div>` : ''}${input}</div>`;
}

async function loadDynamicDropdowns(props) {
  for (const [name, spec] of Object.entries(props)) {
    if (spec['x-dynamic']) {
      try {
        const res = await fetch(spec['x-dynamic']);
        const data = await res.json();
        const select = document.getElementById(`ctrl-${name}`);
        if (select && data.backends) {
          select.innerHTML = data.backends
            .filter(b => b.available)
            .map(b => `<option value="${b.type}" ${b.active ? 'selected' : ''}>${b.type}</option>`)
            .join('');
        }
      } catch (e) { /* ignore */ }
    }
  }
}

function toggleAdvanced() {
  const el = document.getElementById('advanced-fields');
  const toggle = document.getElementById('advanced-toggle');
  el.classList.toggle('visible');
  toggle.textContent = el.classList.contains('visible') ? 'Hide advanced' : 'Show advanced...';
}

// ---- Templates ----
async function loadTemplates() {
  try {
    const res = await fetch('/v2/controls/templates');
    const data = await res.json();
    const container = document.getElementById('templates-section');
    if (!data.templates || data.templates.length === 0) { container.innerHTML = ''; return; }
    container.innerHTML = data.templates.map(t => `
      <div class="template-card" onclick="applyTemplate(${JSON.stringify(t).replace(/"/g, '&quot;')})">
        <div class="name">${t.name}</div>
        <div class="desc">${t.description}</div>
      </div>
    `).join('');
  } catch (e) { /* ignore */ }
}

function applyTemplate(tmpl) {
  if (tmpl.example_task) {
    const taskEl = document.getElementById('ctrl-task');
    if (taskEl) taskEl.value = tmpl.example_task;
  }
  if (tmpl.manifest_defaults && tmpl.manifest_defaults.profile) {
    const profileEl = document.getElementById('ctrl-profile');
    if (profileEl) profileEl.value = tmpl.manifest_defaults.profile;
  }
}

// ---- Runs ----
async function loadRuns() {
  try {
    const verdict = document.getElementById('filter-verdict').value;
    const params = new URLSearchParams();
    if (verdict) params.set('verdict', verdict);
    const res = await fetch('/v2/runs?' + params.toString());
    const data = await res.json();
    lastRuns = data.runs || [];
    renderRunList(lastRuns);
  } catch (e) {
    console.error('Failed to load runs:', e);
  }
}

function renderRunList(runs) {
  const list = document.getElementById('run-list');
  const empty = document.getElementById('runs-empty');
  if (runs.length === 0) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  list.innerHTML = runs.map(r => `
    <li class="run-item" onclick="selectRun('${r.run_id}')">
      <span class="verdict-badge ${r.verdict}">${r.verdict}</span>
      <div class="run-info">
        <div class="task">${escHtml(r.task || r.run_id)}</div>
        <div class="meta">${r.profile} &middot; ${r.model} &middot; ${formatTime(r.created_at)}</div>
      </div>
    </li>
  `).join('');
}

// ---- Run Detail ----
async function selectRun(runId) {
  currentRunId = runId;
  switchTab('detail');
  await loadRunDetail(runId);
}

async function loadRunDetail(runId) {
  const content = document.getElementById('detail-content');
  const empty = document.getElementById('detail-empty');

  try {
    const [detailRes, claimsRes, violationsRes] = await Promise.all([
      fetch(`/v2/runs/${runId}`),
      fetch(`/v2/runs/${runId}/claims`),
      fetch(`/v2/runs/${runId}/violations`),
    ]);
    const detail = await detailRes.json();
    const claimsData = await claimsRes.json();
    const violationsData = await violationsRes.json();

    const summary = detail.summary || {};
    const manifest = detail.manifest || {};
    const claims = claimsData.claims || [];
    const violations = violationsData.violations || [];

    empty.style.display = 'none';
    content.style.display = 'block';
    content.innerHTML = `
      <div class="detail-header">
        <h2>${escHtml(summary.task || runId)}</h2>
        <div class="meta">
          <span class="verdict-badge ${summary.verdict || 'pending'}">${summary.verdict || 'pending'}</span>
          &nbsp; ${summary.profile || ''} &middot; ${summary.model || ''} &middot; ${formatTime(summary.created_at)}
        </div>
      </div>

      <div class="detail-section">
        <h3>Claims (${claims.length})</h3>
        ${claims.length ? `<table class="detail-table">
          <tr><th>Type</th><th>Subject</th><th>Predicate</th><th>Confidence</th></tr>
          ${claims.map(c => `<tr><td>${c.type}</td><td>${escHtml(c.subject)}</td><td>${c.predicate}</td><td>${(c.confidence || 0).toFixed(2)}</td></tr>`).join('')}
        </table>` : '<div class="empty-state">No claims extracted</div>'}
      </div>

      <div class="detail-section">
        <h3>Violations (${violations.length})</h3>
        ${violations.length ? `<table class="detail-table">
          <tr><th>Kind</th><th>Verdict</th><th>Details</th></tr>
          ${violations.map(v => `<tr><td>${v.kind}</td><td>${v.payload?.verdict || ''}</td><td>${escHtml(JSON.stringify(v.payload || {})).slice(0, 120)}</td></tr>`).join('')}
        </table>` : '<div class="empty-state">No violations</div>'}
      </div>

      <div class="detail-section">
        <h3>Reproducibility</h3>
        <div class="repro-block">Run ID: ${runId}
Profile: ${manifest.config?.profile || summary.profile || ''}
Git SHA: ${manifest.repo?.git_sha || 'N/A'}
Repro: governor instrument replay ${runId}</div>
      </div>

      <div class="actions" style="margin-top: 1rem;">
        <button class="btn" onclick="loadReport('${runId}')">Generate Report</button>
      </div>
    `;

    // Also load artifacts for this run
    loadArtifacts(runId);
  } catch (e) {
    content.innerHTML = `<div class="empty-state">Error loading run: ${e.message}</div>`;
    content.style.display = 'block';
    empty.style.display = 'none';
  }
}

async function loadReport(runId) {
  try {
    const res = await fetch(`/v2/runs/${runId}/report`);
    const report = await res.json();
    const content = document.getElementById('detail-content');
    const verdictClass = report.verdict === 'pass' ? 'pass' : 'fail';
    const sectionsHtml = (report.sections || []).map(s =>
      `<li>${escHtml(s.title || s.name || 'Section')}</li>`
    ).join('');
    content.insertAdjacentHTML('beforeend', `
      <div class="detail-section" data-testid="report-section">
        <h3>Report <span class="verdict-badge ${verdictClass}">${report.verdict}</span></h3>
        <div style="font-size:0.8rem;color:var(--muted);margin-bottom:0.5rem;">Hash: <code>${escHtml(report.manifest_hash || '')}</code></div>
        ${sectionsHtml ? `<ul style="font-size:0.85rem;margin-left:1.5rem;">${sectionsHtml}</ul>` : '<div class="empty-state">No sections</div>'}
      </div>
    `);
  } catch (e) {
    const content = document.getElementById('detail-content');
    content.insertAdjacentHTML('beforeend', `
      <div class="detail-section"><h3>Report</h3><div class="empty-state">Failed to generate report: ${escHtml(e.message)}</div></div>
    `);
  }
}

// ---- Artifacts ----
async function loadArtifacts(runId) {
  const content = document.getElementById('artifacts-content');
  const empty = document.getElementById('artifacts-empty');
  try {
    const res = await fetch(`/v2/artifacts?run_id=${runId}`);
    const data = await res.json();
    const artifacts = data.artifacts || [];
    if (artifacts.length === 0) {
      content.style.display = 'none';
      empty.style.display = 'block';
      empty.textContent = 'No artifacts for this run.';
      return;
    }
    empty.style.display = 'none';
    content.style.display = 'block';
    content.innerHTML = `<table class="detail-table">
      <tr><th>Hash</th><th>Size</th><th>MIME</th><th>Stored</th></tr>
      ${artifacts.map(a => `<tr>
        <td><code>${a.artifact_hash.slice(0, 16)}...</code></td>
        <td>${a.size_bytes} B</td>
        <td>${a.mime_type}</td>
        <td>${formatTime(a.stored_at)}</td>
      </tr>`).join('')}
    </table>`;
  } catch (e) {
    content.innerHTML = `<div class="empty-state">Error: ${e.message}</div>`;
    content.style.display = 'block';
    empty.style.display = 'none';
  }
}

// ---- Start / Cancel / Rerun ----
async function startRun() {
  const task = document.getElementById('ctrl-task')?.value || '';
  if (!task.trim()) { alert('Enter a task description.'); return; }

  const profile = document.getElementById('ctrl-profile')?.value || 'established';
  const backend = document.getElementById('ctrl-backend')?.value || '';
  const scopeRaw = document.getElementById('ctrl-scope')?.value || '';
  const scope = scopeRaw ? scopeRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
  const seedEl = document.getElementById('ctrl-seed');
  const seed = seedEl && seedEl.value ? parseInt(seedEl.value, 10) : null;

  const body = { task, profile, backend, scope };
  if (seed !== null) body.seed = seed;

  const btn = document.getElementById('btn-start');
  btn.disabled = true;

  try {
    const res = await fetch('/v2/runs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    activeRunId = data.run_id;

    // Show active indicator
    showActiveIndicator(data.run_id);
    document.getElementById('btn-cancel').disabled = false;
    document.getElementById('btn-rerun').disabled = false;

    // Refresh and show detail
    await loadRuns();
    await selectRun(data.run_id);
  } catch (e) {
    alert('Failed to start run: ' + e.message);
  } finally {
    btn.disabled = false;
  }
}

async function cancelRun() {
  if (!activeRunId) return;
  const btn = document.getElementById('btn-cancel');
  btn.textContent = 'Cancelling...';
  btn.disabled = true;

  try {
    await fetch(`/v2/runs/${activeRunId}/cancel`, { method: 'POST' });
    hideActiveIndicator();
    activeRunId = null;
    await loadRuns();
    if (currentRunId) await loadRunDetail(currentRunId);
  } catch (e) {
    alert('Cancel failed: ' + e.message);
  } finally {
    btn.textContent = 'Stop';
    btn.disabled = !activeRunId;
  }
}

async function rerunLast() {
  if (lastRuns.length === 0) return;
  const last = lastRuns[0];
  document.getElementById('ctrl-task').value = last.task || '';
  const profileEl = document.getElementById('ctrl-profile');
  if (profileEl && last.profile) profileEl.value = last.profile;
  await startRun();
}

function showActiveIndicator(runId) {
  const el = document.getElementById('active-indicator');
  document.getElementById('active-run-label').textContent = `Running: ${runId}`;
  el.classList.add('visible');
}

function hideActiveIndicator() {
  document.getElementById('active-indicator').classList.remove('visible');
}

// ---- Tabs ----
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + name));
}

// ---- Status Polling ----
function startStatusPolling() {
  updateStatus();
  setInterval(updateStatus, 5000);
}

async function updateStatus() {
  try {
    const res = await fetch('/v2/dashboard/summary');
    const data = await res.json();
    document.getElementById('status-runs').textContent = `Runs: ${data.total_runs}`;
    const lastVerdict = data.total_runs > 0
      ? `Pass rate: ${(data.pass_rate * 100).toFixed(0)}%`
      : 'Last: --';
    document.getElementById('status-verdict').textContent = lastVerdict;
  } catch (e) { /* ignore */ }

  try {
    const res = await fetch('/v2/dashboard/regime');
    const data = await res.json();
    document.getElementById('status-regime').textContent = `Regime: ${data.regime || '--'}`;
  } catch (e) { /* ignore */ }

  // Update profile from controls
  const profileEl = document.getElementById('ctrl-profile');
  if (profileEl) {
    document.getElementById('status-profile').textContent = `Profile: ${profileEl.value}`;
  }
}

// ---- Utilities ----
function escHtml(s) {
  const div = document.createElement('div');
  div.textContent = s || '';
  return div.innerHTML;
}

function formatTime(iso) {
  if (!iso) return '--';
  try {
    const d = new Date(iso);
    return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
  } catch { return iso; }
}

// Boot
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
